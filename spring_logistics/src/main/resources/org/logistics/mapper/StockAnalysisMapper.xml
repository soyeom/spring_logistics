<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.logistics.mapper.StockAnalysisMapper">

  <!-- 기준 품목 리스트 -->
  <select id="getBaseItemList"
          parameterType="org.logistics.domain.StockAnalysisRequestDTO"
          resultType="org.logistics.domain.StockAnalysisResponseDTO">
    SELECT DISTINCT
      im.item_id AS itemId,
      im.item_name AS itemName,
      im.spec AS spec,
      im.asset_class AS itemAssetClass,
      im.big_category AS itemBigCategory,
      im.mid_category AS itemMidCategory,
      im.small_category AS itemSmallCategory,
      im.base_unit AS baseUnit,
      im.importance_level AS importanceLevel
    FROM item_master im
    <if test="dto.warehouseId != null">
      INNER JOIN warehouse_item wi
        ON im.item_id = wi.item_id
        AND im.bu_id = wi.bu_id
        AND wi.warehouse_id = #{dto.warehouseId}
    </if>
    WHERE 1=1
      <if test="dto.buId != null">
        AND im.bu_id = #{dto.buId}
      </if>
      <if test="dto.itemAssetClass != null and dto.itemAssetClass != ''">
        AND im.asset_class = #{dto.itemAssetClass}
      </if>
      <if test="dto.importanceLevel != null and dto.importanceLevel != ''">
        AND im.importance_level = #{dto.importanceLevel}
      </if>
      <if test="dto.itemId != null">
        AND im.item_id = #{dto.itemId}
      </if>
      <if test="dto.itemName != null and dto.itemName != ''">
        AND im.item_name LIKE '%' || #{dto.itemName} || '%'
      </if>
      <if test="dto.spec != null and dto.spec != ''">
        AND im.spec LIKE '%' || #{dto.spec} || '%'
      </if>
      <if test="dto.itemSmallCategory != null and dto.itemSmallCategory != ''">
        AND im.small_category = #{dto.itemSmallCategory}
      </if>
    ORDER BY im.item_name
  </select>

  <!-- 기간별 분석값 -->
  <select id="getPeriodValue"
          parameterType="map"
          resultType="double">
    SELECT
      <choose>
        <when test="analysisItem != null and analysisItem.equals('totalIn')">
          NVL(SUM(ibd.qty), 0)
        </when>
        <when test="analysisItem != null and analysisItem.equals('totalOut')">
          NVL(SUM(od.qty), 0)
        </when>
        <when test="analysisItem != null and analysisItem.equals('averageStock')">
          (NVL(SUM(ibd.qty),0) - NVL(SUM(od.qty),0)) / 2
        </when>
        <when test="analysisItem != null and analysisItem.equals('turnoverRate')">
          CASE
            WHEN ((NVL(SUM(ibd.qty),0) - NVL(SUM(od.qty),0)) / 2) = 0 THEN 0
            ELSE (NVL(SUM(od.qty),0) / ((NVL(SUM(ibd.qty),0) - NVL(SUM(od.qty),0)) / 2)) * 100
          END
        </when>
        <otherwise>0</otherwise>
      </choose>
    FROM item_master im
    LEFT JOIN inbound_detail ibd
      ON im.item_id = ibd.item_id
      AND im.bu_id = ibd.bu_id
    <if test="dto.warehouseId != null">
      AND ibd.warehouse_id = #{dto.warehouseId}
    </if>
    LEFT JOIN inbound_master ibm
      ON ibd.inbound_id = ibm.inbound_id
    <if test="startMonth != null and endMonth != null">
      AND ibm.inbound_date BETWEEN
      TO_DATE(#{startMonth} || '01','YYYYMMDD')
      AND LAST_DAY(TO_DATE(#{endMonth} || '01','YYYYMMDD')) + 0.99999
    </if>
    LEFT JOIN out_detail od
      ON im.item_id = od.item_id
      AND im.bu_id = od.bu_id
    <if test="dto.warehouseId != null">
      AND od.warehouse_id = #{dto.warehouseId}
    </if>
    LEFT JOIN out_master om
      ON od.out_id = om.out_id
    <if test="startMonth != null and endMonth != null">
      AND om.out_date BETWEEN
      TO_DATE(#{startMonth} || '01','YYYYMMDD')
      AND LAST_DAY(TO_DATE(#{endMonth} || '01','YYYYMMDD')) + 0.99999
    </if>
    WHERE im.item_id = #{dto.itemId}
    <if test="dto.buId != null">
      AND im.bu_id = #{dto.buId}
    </if>
    <if test="dto.itemSmallCategory != null and dto.itemSmallCategory != ''">
      AND im.small_category = #{dto.itemSmallCategory}
    </if>
  </select>

</mapper>
