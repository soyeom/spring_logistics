<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.logistics.mapper.StockAnalysisMapper">

    <select id="getStockAnalysisData" parameterType="org.logistics.domain.StockAnalysisRequestDTO" resultType="org.logistics.domain.StockAnalysisResponseDTO">
        SELECT
            bu.bu_name AS buName,
            wh.warehouse_name AS warehouseName,
            im.item_name AS itemName,
            im.spec,
            im.base_unit AS baseUnit,
            im.item_internal_code AS itemInternalCode,
            im.big_category AS itemBigCategory,
            im.mid_category AS itemMidCategory,
            im.small_category AS itemSmallCategory,
            im.asset_class AS assetClass,

                        (
                SELECT NVL(SUM(qty), 0)
                FROM inbound_detail
                WHERE item_id = im.item_id AND created_at &lt; #{startDate, jdbcType=DATE}
            )
            -
            (
                SELECT NVL(SUM(qty), 0)
                FROM out_detail
                WHERE item_id = im.item_id AND created_at &lt; #{startDate, jdbcType=DATE}
            ) AS beginningStock,

            (
                SELECT NVL(SUM(qty), 0)
                FROM inbound_detail
                WHERE item_id = im.item_id AND created_at BETWEEN #{startDate, jdbcType=DATE} AND #{endDate, jdbcType=DATE}
            ) AS inboundQty,

            (
                SELECT NVL(SUM(qty), 0)
                FROM out_detail
                WHERE item_id = im.item_id AND created_at BETWEEN #{startDate, jdbcType=DATE} AND #{endDate, jdbcType=DATE}
            ) AS outQty,

            (
                SELECT NVL(SUM(qty), 0)
                FROM inbound_detail
                WHERE item_id = im.item_id AND created_at &lt;= #{endDate, jdbcType=DATE}
            )
            -
            (
                SELECT NVL(SUM(qty), 0)
                FROM out_detail
                WHERE item_id = im.item_id AND created_at &lt;= #{endDate, jdbcType=DATE}
            ) AS endingStock


        FROM item_master im
        LEFT JOIN business_unit bu ON im.bu_id = bu.bu_id
        LEFT JOIN warehouse_item wi ON im.item_id = wi.item_id
        LEFT JOIN warehouse_detail wh ON wi.warehouse_id = wh.warehouse_id

        WHERE 1=1
        <if test="buId != null">
            AND im.bu_id = #{buId}
        </if>
        <if test="warehouseId != null">
            AND wh.warehouse_id = #{warehouseId}
        </if>
        <if test="itemBigCategory != null and itemBigCategory != ''">
            AND im.big_category = #{itemBigCategory}
        </if>
        <if test="itemMidCategory != null and itemMidCategory != ''">
            AND im.mid_category = #{itemMidCategory}
        </if>
        <if test="itemSmallCategory != null and itemSmallCategory != ''">
            AND im.small_category = #{itemSmallCategory}
        </if>
        <if test="itemInternalCode != null and itemInternalCode != ''">
            AND im.item_internal_code LIKE '%' || #{itemInternalCode} || '%'
        </if>
        <if test="itemName != null and itemName != ''">
            AND im.item_name LIKE '%' || #{itemName} || '%'
        </if>
        <if test="spec != null and spec != ''">
            AND im.spec LIKE '%' || #{spec} || '%'
        </if>
        <if test="baseUnit != null and baseUnit != ''">
            AND im.base_unit = #{baseUnit}
        </if>
        <if test="importanceLevel != null and importanceLevel != ''">
            AND im.importance_level = #{importanceLevel}
        </if>
    </select>

</mapper>
