<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.logistics.mapper.OrderMapper">

	<!-- ========================================================= -->
	<!-- ðŸ—‚ï¸ OrderMapper.xml - å—æ³¨(å…¥åº«)ç®¡ç†SQLãƒžãƒƒãƒ”ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ« -->
	<!-- (ìˆ˜ì£¼ / ìž…ê³  ê´€ë¦¬ìš© SQL ë§¤í•‘ íŒŒì¼) -->
	<!-- ========================================================= -->


	<!-- ================== ðŸ§© OrderDTO ë§¤í•‘ ================== -->
	<!-- âœ… ãƒžã‚¹ã‚¿(å—æ³¨æƒ…å ±)ã®çµæžœãƒžãƒƒãƒ”ãƒ³ã‚° / ìˆ˜ì£¼ ë§ˆìŠ¤í„° ì •ë³´ ë§¤í•‘ -->
	<resultMap id="OrderResultMap" type="org.logistics.model.OrderDTO">
		<id property="orderId" column="inbound_id" />
		<result property="buId" column="bu_id" />
		<result property="inboundDate" column="inbound_date" />
		<result property="localFlag" column="local_flag" />
		<result property="inboundType" column="inbound_type" />
		<result property="inboundComplete" column="inbound_complete" />
		<result property="partyId" column="party_id" />
		<result property="contactId" column="contact_id" />
		<result property="partyName" column="party_name" />
		<result property="contactName" column="contact_name" />
		<result property="department" column="department" />
<!-- 		<result property="currencyCode" column="currency_code" /> -->
		<result property="createdAt" column="created_at" />
	</resultMap>


	<!-- ================== ðŸ§© OrderDetailDTO ë§¤í•‘ ================== -->
	<!-- âœ… æ˜Žç´°(å—æ³¨æ˜Žç´°)ã®çµæžœãƒžãƒƒãƒ”ãƒ³ã‚° / ìˆ˜ì£¼ ìƒì„¸ì •ë³´ ë§¤í•‘ -->
	<resultMap id="OrderDetailResultMap" type="org.logistics.model.OrderDetailDTO">
		<id property="inboundDetailId" column="inbound_detail_id" />
		<result property="inboundId" column="inbound_id" />
		<result property="buId" column="bu_id" />
		<result property="itemId" column="item_id" />
		<result property="qty" column="qty" />
		<result property="surtaxYn" column="surtax_yn" />
		<result property="unitPrice" column="unit_price" />
		<result property="amount" column="amount" />
		<result property="note" column="note" />
		<result property="warehouseId" column="warehouse_id" />
		<result property="itemName" column="item_name" />
		<result property="spec" column="spec" />
		<result property="unit" column="base_unit" />
		<result property="inboundDate" column="inbound_date" />
		<result property="inboundComplete" column="inbound_complete" />
		<result property="warehouseName" column="warehouse_name" />
	</resultMap>


	<!-- ================== ðŸ“ ë§ˆìŠ¤í„° ë“±ë¡ ================== -->
	<!-- âœ… ãƒžã‚¹ã‚¿ç™»éŒ²SQL / ìˆ˜ì£¼ ë§ˆìŠ¤í„° ì‹ ê·œ ë“±ë¡ -->
	<insert id="insertOrder" parameterType="org.logistics.model.OrderDTO">
		INSERT INTO inbound_master (
			inbound_id, bu_id, inbound_date, local_flag,
			party_id, contact_id, inbound_type,
			inbound_complete, created_at
		)
		VALUES (
			#{orderId}, #{buId},
			TO_DATE(#{inboundDate}, 'YYYY-MM-DD'),
			#{localFlag}, #{partyId}, #{contactId},
			#{inboundType}, #{inboundComplete}, SYSDATE
		)
	</insert>


	<!-- ================== ðŸ” ë§ˆìŠ¤í„° ë‹¨ê±´ ì¡°íšŒ ================== -->
	<!-- âœ… å—æ³¨å˜ä»¶ç…§ä¼šSQL / ë‹¨ê±´ ìˆ˜ì£¼ ì¡°íšŒ -->
	<select id="selectOrder" resultMap="OrderResultMap">
		SELECT ib.*, p.party_name, c.contact_name, c.department
		FROM inbound_master ib
		LEFT JOIN party p ON ib.party_id = p.party_id
		LEFT JOIN contact c ON ib.contact_id = c.contact_id
		WHERE ib.inbound_id = #{orderId}
		AND ib.bu_id = #{buId}
	</select>


	<!-- ================== âœï¸ ë§ˆìŠ¤í„° ìˆ˜ì • ================== -->
	<!-- âœ… ãƒžã‚¹ã‚¿æ›´æ–°SQL / ìˆ˜ì£¼ ë§ˆìŠ¤í„° ìˆ˜ì • -->
	<update id="updateOrder" parameterType="org.logistics.model.OrderDTO">
		UPDATE inbound_master
		SET inbound_date = TO_DATE(#{inboundDate}, 'YYYY-MM-DD'),
		    local_flag = #{localFlag},
		    party_id = #{partyId},
		    contact_id = #{contactId},
		    inbound_type = #{inboundType},
		    inbound_complete = #{inboundComplete}
		WHERE inbound_id = #{orderId}
		AND bu_id = #{buId}
	</update>


	<!-- ================== âŒ ë§ˆìŠ¤í„° ì‚­ì œ ================== -->
	<!-- âœ… ãƒžã‚¹ã‚¿å‰Šé™¤SQL / ìˆ˜ì£¼ ë§ˆìŠ¤í„° ì‚­ì œ -->
	<delete id="deleteOrder">
		DELETE FROM inbound_master
		WHERE inbound_id = #{orderId}
		AND bu_id = #{buId}
	</delete>


	<!-- ================== ðŸ§¾ ë””í…Œì¼ ë“±ë¡ ================== -->
	<!-- âœ… æ˜Žç´°ç™»éŒ²SQL / ìˆ˜ì£¼ ìƒì„¸ ì‹ ê·œ ë“±ë¡ -->
	<insert id="insertOrderDetail" parameterType="org.logistics.model.OrderDetailDTO">
		INSERT INTO inbound_detail (
			inbound_detail_id, bu_id, inbound_id, item_id, qty,
			surtax_yn, unit_price, amount, note, warehouse_id
		)
		VALUES (
			#{inboundDetailId}, #{buId}, #{inboundId}, #{itemId},
			#{qty}, #{surtaxYn}, #{unitPrice}, #{amount},
			#{note}, #{warehouseId}
		)
	</insert>


	<!-- ================== ðŸ“¦ ìƒì„¸ì¡°íšŒ ================== -->
	<!-- âœ… å—æ³¨æ˜Žç´°ç…§ä¼šSQL / ìˆ˜ì£¼ ìƒì„¸ì¡°íšŒ -->
	<select id="selectOrderDetails" resultMap="OrderDetailResultMap">
		SELECT
			d.inbound_detail_id,
			d.inbound_id,
			d.bu_id,
			d.item_id,
			i.item_name,
			i.spec,
			i.base_unit AS unit,
			d.qty,
			d.unit_price,
			d.amount,
			d.surtax_yn,
			d.note,
			d.warehouse_id,
			wd.warehouse_name AS warehouseName,
			TO_CHAR(ib.inbound_date,'YYYY-MM-DD') AS inboundDate,
			ib.inbound_complete AS inboundComplete,
			p.party_name AS partyName
		FROM inbound_detail d
		JOIN item_master i ON d.item_id = i.item_id
		LEFT JOIN warehouse_detail wd ON d.warehouse_id = wd.warehouse_id AND d.bu_id = wd.bu_id
		LEFT JOIN inbound_master ib ON d.inbound_id = ib.inbound_id
		LEFT JOIN party p ON ib.party_id = p.party_id
		WHERE d.inbound_id = #{orderId}
		AND d.bu_id = #{buId}
	</select>


	<!-- ================== ðŸ—‘ï¸ ë””í…Œì¼ ì‚­ì œ ================== -->
	<!-- âœ… æ˜Žç´°å‰Šé™¤SQL / ìƒì„¸ ì‚­ì œ -->
	<delete id="deleteOrderDetails">
		DELETE FROM inbound_detail
		WHERE inbound_id = #{orderId}
		AND bu_id = #{buId}
	</delete>


	
<!-- ================== ðŸ”Ž ê²€ìƒ‰ ================== -->
<!-- âœ… å—æ³¨æ¡ä»¶æ¤œç´¢SQL / ì¡°ê±´ ê²€ìƒ‰ -->
<!-- ================== ðŸ” ìˆ˜ì£¼ ì¡°ê±´ ê²€ìƒ‰ ================== -->
<!-- âœ… inbound_master + party_master + contact_master JOIN (í™˜ìœ¨ ì œì™¸) -->
<select id="searchOrders" resultMap="OrderResultMap">
    SELECT 
        im.inbound_id,
        im.bu_id,
        im.inbound_date,
        im.local_flag,
        im.inbound_type,
        im.inbound_complete,
        im.party_id,
        im.contact_id,
        im.created_at,
        p.party_name,
        c.contact_name,
        c.department
    FROM inbound_master im
    LEFT JOIN party p ON im.party_id = p.party_id
    LEFT JOIN contact c ON im.contact_id = c.contact_id
    <where>
        <if test="buId != null and buId != ''">
            AND im.bu_id = #{buId}
        </if>
        <if test="inboundType != null and inboundType != ''">
            AND im.inbound_type = #{inboundType}
        </if>
        <if test="localFlag != null and localFlag != ''">
            AND im.local_flag = #{localFlag}
        </if>
        <if test="startDate != null and startDate != ''">
            AND im.inbound_date &gt;= TO_DATE(#{startDate}, 'YYYY-MM-DD')
        </if>
        <if test="endDate != null and endDate != ''">
            AND im.inbound_date &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
        </if>
        <if test="partyId != null and partyId != ''">
            AND im.party_id = #{partyId}
        </if>
        <if test="contactId != null and contactId != ''">
            AND im.contact_id = #{contactId}
        </if>
    </where>
    ORDER BY im.inbound_date DESC
</select>






	<!-- ================== ðŸ“‹ Item Master ì¡°íšŒ ================== -->
	<!-- âœ… å“ç›®ãƒžã‚¹ã‚¿ä¸€è¦§SQL / í’ˆëª© ë§ˆìŠ¤í„° ê¸°ë³¸ ì¡°íšŒ -->
	<select id="selectItemMasterByBuId" resultMap="OrderDetailResultMap">
		SELECT i.item_id, i.item_name, i.spec, i.base_unit,
		       '0' qty, 'N' surtax_yn, '0' unit_price, '0' amount,
		       NULL note, NULL warehouse_id,
		       NULL inbound_date, 'N' inbound_complete
		FROM item_master i
		WHERE i.bu_id = #{buId}
		ORDER BY i.item_id
	</select>


	<!-- ================== âš™ï¸ ê³µí†µ ë§ˆìŠ¤í„° ì¡°íšŒ ================== -->
	<!-- âœ… å…±é€šãƒžã‚¹ã‚¿å‚ç…§SQL / ê³µí†µ ì½”ë“œ ì¡°íšŒ -->
	<select id="getBusinessUnitList" resultType="org.logistics.model.BusinessUnitVO">
		SELECT bu_id AS buId, bu_name AS buName
		FROM business_unit
	</select>

	<select id="getInboundTypeList" resultType="string">
		SELECT DISTINCT inbound_type FROM inbound_master
	</select>

	<select id="getInboundTypeListByBuId" resultType="string">
		SELECT DISTINCT inbound_type FROM inbound_master WHERE bu_id = #{buId}
	</select>

	<select id="getLocalFlagList" resultType="string">
		SELECT DISTINCT local_flag FROM inbound_master
	</select>

	<select id="getConsignmentList" resultType="string">
		SELECT DISTINCT consignment_gubun FROM out_master
	</select>

	<select id="getCurrencyList" resultType="string">
		SELECT currency_code FROM currency_rate
	</select>


	<!-- ================== ðŸ“‘ ìˆ˜ì£¼ ë””í…Œì¼ í™•ìž¥ ì¡°íšŒ ================== -->
	<!-- âœ… inbound_detail + item_master + party JOIN / ìˆ˜ì£¼ ìƒì„¸ + í’ˆëª©ì •ë³´ + ê±°ëž˜ì²˜ì •ë³´ -->
	<select id="getOrderList" resultType="org.logistics.model.OrderDetailDTO">
		SELECT 
			a.inbound_detail_id AS inboundDetailId,
			a.inbound_id        AS inboundId,
			a.bu_id             AS buId,
			a.item_id           AS itemId,
			a.qty               AS qty,
			a.surtax_yn         AS surtaxYn,
			a.unit_price        AS unitPrice,
			a.amount            AS amount,
			a.note              AS note,
			a.warehouse_id      AS warehouseId,
			wd.warehouse_name   AS warehouseName,
			b.item_name         AS itemName,
			b.spec              AS spec,
			b.base_unit         AS baseUnit,
			p.party_name        AS partyName,
			NULL                AS vat,
			NULL                AS krwAmount,
			NULL                AS krwVat,
			m.inbound_date      AS inboundDate,
			NULL	               AS OutType,
			m.inbound_complete  AS inboundComplete
		FROM inbound_detail a
		JOIN item_master b ON a.bu_id = b.bu_id AND a.item_id = b.item_id
		JOIN warehouse_detail wd ON a.bu_id = wd.bu_id AND TO_NUMBER(a.warehouse_id) = wd.warehouse_id
		JOIN inbound_master m ON a.inbound_id = m.inbound_id AND a.bu_id = m.bu_id
		JOIN party p ON m.party_id = p.party_id
		WHERE a.bu_id = #{buId}
		AND a.inbound_id = #{orderId}
	</select>

</mapper>
