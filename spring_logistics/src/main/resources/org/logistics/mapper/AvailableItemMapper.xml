<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.logistics.mapper.AvailableItemMapper">

  <select id="getAvailableItems" resultType="org.logistics.domain.AvailableItemVO">
    SELECT w.warehouse_name   AS warehouseName
         , w.warehouse_id     AS warehouseId
         , i.asset_class      AS assetClass
         , i.item_name        AS itemName
         , i.spec             AS spec
         , i.item_id          AS itemId
         , i.base_unit        AS baseUnit
         , i.safety_stock_qty AS safetyQty
         , SUM(CASE WHEN m.inbound_complete = 'Y' THEN d.qty ELSE 0 END) AS totalQty <!-- 입고완료(Y) 건의 수량 합계 -->
         , SUM(CASE WHEN m.inbound_complete = 'N' AND m.inbound_type = '생산의뢰' THEN d.qty ELSE 0 END) AS requestQty<!-- 입고 미완료(N) + '생산의뢰' 유형 -->
         , SUM(CASE WHEN m.inbound_complete = 'N' AND m.inbound_type = '구매발주' THEN d.qty ELSE 0 END) AS orderQty<!-- 입고 미완료(N) + '구매발주' 유형 -->
         , SUM(CASE WHEN m.inbound_complete = 'N' AND m.inbound_type = '적송요청' THEN d.qty ELSE 0 END) AS transferQty<!-- 입고 미완료(N) + '적송요청' 유형 -->
         , SUM(CASE WHEN m.inbound_complete = 'N' AND m.inbound_type = '기타입고요청' THEN d.qty ELSE 0 END) AS inboundQty<!-- 입고 미완료(N) + '기타입고요청' 유형 -->
         , SUM(CASE WHEN m.inbound_complete = 'N' THEN d.qty ELSE 0 END) AS expectedQty <!-- 미완료 전체 합계 -->
    FROM inbound_master m <!-- 입고 마스터와 입고 디테일 조인 -->
    JOIN inbound_detail d
      ON m.bu_id = d.bu_id
     AND m.inbound_id = d.inbound_id
    JOIN item_master i <!-- 입고 디테일과 품목 마스터 조인 -->
      ON d.bu_id = i.bu_id
     AND d.item_id = i.item_id
    JOIN warehouse_detail w <!-- 입고 디테일과 창고 마스터 조인 -->
      ON d.bu_id = w.bu_id
     AND d.warehouse_id = w.warehouse_id
    GROUP BY w.warehouse_name, w.warehouse_id, <!-- 결과 묶기 -->
             i.asset_class, i.item_name, i.spec, i.item_id, i.base_unit, i.safety_stock_qty
    ORDER BY i.item_id <!-- 품번 순서대로 정렬 -->
  </select>

</mapper>
